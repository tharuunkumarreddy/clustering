name: Download Training Model from CDN
description: Downloads trained model (.pkl) and metadata (.json) from CDN URLs for production inference

inputs:
  - name: model_cdn_url
    type: String
    description: "CDN URL for trained model (PKL format)"
  - name: metadata_cdn_url
    type: String
    description: "CDN URL for training metadata (JSON format)"

outputs:
  - name: model
    type: Model
    description: "Downloaded trained model (PKL format)"
  - name: metadata
    type: Data
    description: "Downloaded training metadata (JSON format)"
  - name: download_summary
    type: Data
    description: "JSON summary of downloaded files"

implementation:
  container:
    image: nikhilv215/nesy-factory:v23
    command:
      - python3
      - -u
      - -c
      - |
        import argparse
        import requests
        import json
        import os
        import time
        
        parser = argparse.ArgumentParser(
            description="Download Training Model from CDN"
        )
        
        parser.add_argument('--model_cdn_url', required=True,
                           help="CDN URL for model PKL")
        parser.add_argument('--metadata_cdn_url', required=True,
                           help="CDN URL for metadata JSON")
        
        parser.add_argument('--output_model', required=True,
                           help="Output path for downloaded model")
        parser.add_argument('--output_metadata', required=True,
                           help="Output path for downloaded metadata")
        parser.add_argument('--output_download_summary', required=True,
                           help="Output path for download summary JSON")
        
        args = parser.parse_args()
        
        print("="*80)
        print("CDN DOWNLOAD COMPONENT - TRAINING MODEL")
        print("="*80)
        print("")
        
        def fix_url_encoding(url):
            return url.replace("$$", "$")
        
        def download_file(cdn_url, output_path, file_description, is_binary=False):
            print('Downloading', file_description)
            print('  CDN URL:', cdn_url)
            
            fixed_url = fix_url_encoding(cdn_url)
            
            try:
                print('  Fetching from CDN...')
                response = requests.get(fixed_url, timeout=60)
                response.raise_for_status()
                
                file_size = len(response.content)
                print('  Downloaded:', str(file_size) + ' bytes (' + str(round(file_size/1024, 2)) + ' KB)')
                
                os.makedirs(os.path.dirname(output_path), exist_ok=True)
                
                mode = 'wb' if is_binary else 'w'
                if is_binary:
                    with open(output_path, mode) as f:
                        f.write(response.content)
                else:
                    with open(output_path, mode) as f:
                        f.write(response.text)
                
                print('  Saved to:', output_path)
                print('  Status: Success')
                print("")
                
                return {
                    'status': 'success',
                    'cdn_url': cdn_url,
                    'local_path': output_path,
                    'file_size_bytes': file_size,
                    'file_size_kb': round(file_size / 1024, 2)
                }
            
            except requests.exceptions.RequestException as e:
                print('  Status: Failed')
                print('  Error:', str(e))
                print("")
                raise RuntimeError('Failed to download ' + file_description + ': ' + str(e))
        
        download_results = {}
        
        try:
            model_result = download_file(
                args.model_cdn_url,
                args.output_model,
                "Trained Model (PKL)",
                is_binary=True
            )
            download_results['model'] = model_result
            
            metadata_result = download_file(
                args.metadata_cdn_url,
                args.output_metadata,
                "Training Metadata (JSON)",
                is_binary=False
            )
            download_results['metadata'] = metadata_result
            
            # Verify model file
            try:
                import pickle
                with open(args.output_model, 'rb') as f:
                    model = pickle.load(f)
                print('Model verification:')
                print('  Type:', type(model).__name__)
                print('  Status: Valid PKL file')
                print("")
            except Exception as e:
                print('Warning: Could not verify model file:', str(e))
                print("")
            
            # Verify metadata file
            try:
                with open(args.output_metadata, 'r') as f:
                    metadata = json.load(f)
                print('Metadata verification:')
                print('  Algorithm:', metadata.get('algorithm', 'Unknown'))
                if 'training_results' in metadata:
                    print('  Clusters:', metadata['training_results'].get('n_clusters', 'Unknown'))
                    print('  Features:', metadata['training_results'].get('n_features', 'Unknown'))
                print('  Status: Valid JSON file')
                print("")
            except Exception as e:
                print('Warning: Could not verify metadata file:', str(e))
                print("")
            
            summary = {
                'timestamp': int(time.time()),
                'download_status': 'success',
                'files_downloaded': 2,
                'total_size_bytes': sum(r['file_size_bytes'] for r in download_results.values()),
                'total_size_kb': sum(r['file_size_kb'] for r in download_results.values()),
                'files': download_results
            }
            
            os.makedirs(os.path.dirname(args.output_download_summary), exist_ok=True)
            with open(args.output_download_summary, "w") as f:
                json.dump(summary, f, indent=2)
            
            print("="*80)
            print("CDN DOWNLOAD COMPLETED SUCCESSFULLY")
            print("="*80)
            print('Files downloaded: 2')
            print('Total size:', str(round(summary['total_size_kb'], 2)), 'KB')
            print('Model:', args.output_model)
            print('Metadata:', args.output_metadata)
            print("="*80)
            
        except Exception as e:
            print("")
            print("="*80)
            print("CDN DOWNLOAD FAILED")
            print("="*80)
            print('Error:', str(e))
            print("="*80)
            
            error_summary = {
                'timestamp': int(time.time()),
                'download_status': 'failed',
                'error': str(e),
                'files_downloaded': len(download_results),
                'files': download_results
            }
            
            os.makedirs(os.path.dirname(args.output_download_summary), exist_ok=True)
            with open(args.output_download_summary, "w") as f:
                json.dump(error_summary, f, indent=2)
            
            raise

    args:
      - --model_cdn_url
      - {inputValue: model_cdn_url}
      - --metadata_cdn_url
      - {inputValue: metadata_cdn_url}
      - --output_model
      - {outputPath: model}
      - --output_metadata
      - {outputPath: metadata}
      - --output_download_summary
      - {outputPath: download_summary}
